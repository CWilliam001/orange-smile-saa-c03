Scalability & High Availability

Scalability = an application / system can handle greater loads by adapting
    Vertical Scalability
        Increasing size of the instance
        Eg: 4GB memory => 8GB memory
        Common for non distributed systems such as database like RDS, ElastiCache
        Theres usually a limit to how much you can vertically scale (hardware limit)
    Horizontal Scalability
        Increasing the number of instances / systems for your application
        Implies to distributed systems
        Common for web applications / modern applications

High Availability
    Usually goes hand in hand with horizontal scaling
    Running your application / system in at least 2 data centers (AZ)
    The goal of high availability is to survive a data center loss
    Can be passive (for RDS Multi AZ)
    Can be active (for horizontal scaling)





Load Balancing
    Load Balancers are servers that forward traffic to multiple servers downstream
    Spread load across multiple downstream instances
    Expose a single point of access (DNS) to your application
    Seamlessly handle failures of downstream instances
    Do regular health checks to your instances
    Provide SSL termination (HTTPS) for your websites
    Enforce stickiness with cookies
    High availability across zones
    Separate public traffic from private traffic

ELB
    Managed load balancer
        Guarantees that it will be working
        Takes care of upgrades, maintenance, high availability
        Provides only a few configuration knobs
    It costs less to setup your own load balancer but it will be a lot more effort on your end
    Integrated with many AWS offerings / services
    EC2, EC2 Auto Scaling Groups. Amazon ECS
    AWS Certificate Manager (ACM), CloudWatch
    Route53, AWS WAF, AWS Global Accelerator

Health Checks
    Crucial for load balancers
    Enable the load balancer to know if instances it forwards traffic to are available to reply to requests
    The health check is done on a port and a route (/health is common)
    If response !== 200 (ok), then the instance is unhealth

Types of load balancer on AWS
    Classic Load Balancer (Deprecated)
        Compatible to: HTTP, HTTPS, TCP, SSL
    Application Load Balancer
        Compatible to: HTTP, HTTPS, WebSocket
        Routing tables to differenct target groups
            Based on path in URL (example.com/users & example.com/posts)
            Based on hostname in URL
            Based on Query String, Headers
        Great fit for micro services & container based applicaature to redirect to a dynamic port in ECS
       tion (Docker & ECS)
        Has a port mapping fe In comparison, we'd need multiple CLB per application
    Network Load Balancer
        Compatible to: TCP, TLS, UDP (Layer 4)
        ForwardTCP & UDP traffic to your instances
        Handle millions of request per seconds
        Ultra-low latency
        Has one static IP per AZ, and supports assigning Elastic IP (helpful for whitelisitng specific IP)
        Used for extreme performance, TCP or UDP traffic
        Health checks support the TCP, HTTP and HTTPS Protocols
    Gateway Load Balancer
        Operates at layer 3 (Network Layer) - IP Protocol
        Deploy, scale, and manage a fleet of 3rd party network virtual appliances in AWS
        Firewalls, Intrusion Detection and Prevention Systems, Deep Packet Inspection Systems, payload manipulation
        Combines the following functions:
            Transparent Network Gateway - single entry / exit for all traffic
            Load Balancer - distributes traffic to your virtual appliances
        Uses the GENEVE protocol on port 6081




Sticky Sessions (Session Affinity)
    Possible to implement stickiness so that the same client is always redirected to the same instance behind the load balancer
    Works for Classic Load Balancer, Application Load Balancer, and Network Load Balancer
    The "cookie" used for stickiness has an expiration date you control
    Make sure the user doesnt lose his session data
    Enabling stickiness may bring imbalance to the load over the backend EC2 instances

Cookie Names
    Application-based Cookies
        Custom Cookie
            Generated by the target
            Can include any custom attributes required by the application
            Cookie name must be specified individually for each target group
            Don't use AWSALB, AWSALBAPP, AWSALBTG (reserved for use by the ELB)
        Application Cookie
            Cookie generated by the Load Balancer
            Cookie name is AWSAPB
    Duration-based Cookies
        Cookie generated by the Load Balancer
        Cookie name is AWSALB, for ALB, AWSELB for CLB

SSL / TLS - Basics
    Allows traffic between your clients and your load balancer to be encrypted in transit (in-flight encryption)
    Secure Socket Layer (SSL) used to encrypt connections
    Transport Layer Security (TLS) is a newer version
    Nowadays, TLS certificates are mainly used, but people still refer as SSL
    Public SSL certificates are issued by Certificate Authorities (CA) (Comodo, Symantec, GoDaddy, Global Sign, Digicert, Letsencrypt, etc...)
    SSL certificates have an expiration date (you set) and must be renewed

Load Balancer - SSL Certificates
    Users <-> HTTPS (encrypted) Over www <-> Load Balancer <-> HTTP Over private VPC <-> EC2 Instance
    The load balancer uses an X.509 certificate (SSL/TLS server certificate)
    You can manage certificates using ACM (AWS Certificate Manager)
    You can create upload your own certificates alternatively
    HTTPS listener:
        You must specify a default certificate
        You can add on optional list of certs to support multiple domains
        Clients can use Server Name Indication (SNI) to specify the hostname they reach
        Ability to specify a security policy to support older versions of SSL/TLS (legacy clients)

SSL - Server Name Indication (SNI)
    Solves the problem of loading multiple SSL certificates onto one web server (to serve multiple websites)
    It's a newer protocol, and requires the client to indicate the hostname of the target server in the initial SSL handshake
    The server will then find the correct certificate or return the default one
    Only works for ALB & NLB (newer generation), CloudFront
    Does not work for CLB (older gen)

ELB - SSL Certificates
    CLB
        Support only one SSL certificate
        Must use multiple CLB for multiple hostname with multiple SSL certificates
    ALB
        Supports multiple listeners with multiple SSL certificates
        Uses SNI to make it work
    NLB
        Supports multiple listeners with multiple SSL certificates
        Uses SNI to make it work

Connection Draining
    Feature naming
        Connection Draining - for CLB
        Deregistration Delay - for ALB & NLB
        Time to complete "in-flight-requests" while the Instance is de-registration or unhealthy
        Stops sending new requests to the EC2 Instance which is de-registering
        Between 1 to 3600 seconds (default: 300 seconds)
        Can be disabled (set value to 0)
        Set to a low value if your requests are short

Auto Scaling Group (ASG)
    Scale out (add EC2 Instances) to match an increased load
    Scale in (remove EC2 Instances) to match a decreased load
    Ensure we have a minimum and maximum number of EC2 Instances running
    Automatically register new Instances to a load balancer
    Re-create an EC2 Instance in case a previous one is terminated (eg: if unhealthy)
    ASG are free (you only pay for the underlying EC2 Instances)

ASG in AWS
    Set a minimum capacity which is how many Instances you want at minimum in your ASG (eg: 2)
    Set a desired capacity which is how many Instances you want in your ASG (eg: 4)
    Set a maximum capacity which is how many instances at a maximum do I want in my ASG (eg: 7)
        Means that you can scale out as needed and so the ASG can grow bigger

ASG in AWS with Load Balancer
    ELB will distribute traffic to all those instance immediately for those registered Instance in ASG
    ELB has ability to use health check to check EC2 Instances.
    ASG can terminate EC2 Instances if they are deemed unhealthy by the load balancer
    If I scale out the load, ELB will send traffic to the new Instances as welll and spread the load

ASG Attributes
    Launch Template (older "Launch Configurations" are deprecated)
        AMI + Instance Type
        EC2 User Data
        EBS Volumes
        Security Groups
        SSH Key Pair
        IAM Roles for your EC2 Instances
        Network + Subnets Information
        Load Balancer Information
    Min Size / Max Size / Initial Capacity
    Scaling Policies

Auto Scaling - CloudWatch Alarms & Scaling
    It is possible to scale an ASG based on CloudWatch alarms
    An alarm monitors a metric (such as Average CPU, or a custom metric)
    Metrics such as Average CPU are computed for the overall ASG Instances
    Based on the alarm:
        We can create scale-out policies (Increase the number of Instances)
        We can create scale-in policies (Decrease the number of Instances)

ASG - Scaling Policies
    Dynamic Scaling
        Target Tracking Scaling
            Simple to set-up
            Eg: I want the average ASG CPU to stay at around 40%
        Simple / Step Scaling
            When a CloudWatch alarm is triggered (example CPU > 70%), then add 2 units
            When a CloudWatch alarm is triggered (example CPU < 30%), then remove 1 units
    Scheduled Scaling
        Anticipate a scaling based on known usage patterns
        Eg: Increase the min capacity to 10 at 5 pm on Fridays
    Predictive scaling
        Continuously forecast load and schedule scaling ahead

Good metrics to scale on
    CPU Utilization
        Average CPU utilization across your Instances
    RequestCountPerTarget
        To make sure the number of requests per EC2 Instances is stable
    Average Network In / Out (if you;re application is network bound)
    Any custom metric (that you push using CloudWatch)

ASG - Scaling Cooldowns
    After a scaling activity happens, your are in the cooldown period (default 300 seconds (5 minutes))
    During the cooldown period, the ASG will not launch or terminate additional Instances (to allow for metrics to stabilize)
    Advice: Use a ready-to-use AMI to reduce configuration time in order to be serving request fasters and reduce the cooldown period